<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{movie.ten_phim}}</title>
    <link rel="stylesheet" href="../static/css/style.css">
    <link rel="stylesheet" href="../static/css/style2.css">
    <link rel="stylesheet" href="../static/css/ChonRap_style.css">
</head>

<body>
    <div class="hd_chonrap">
        <div class="hd_chonrap_top">
            <div class="container">
                <div class="hd_chonrap_top_components">
                    <a class="main_logo_link" href="#"> <!--Thay href-->
                        <img src="../static/assets/logo.jpg">
                    </a>
                    <div class="hd_left_action">
                        <a button class="btn book_btn" href="{{ url_for('home') }}"> <!--Thay href-->
                            <img src="https://cinestar.com.vn/assets/images/ic-ticket.svg">
                            <span class="text">Đặt vé ngay</span>
                        </a>
                    </div>
                    <div class="hd_right_action">
                        <!--Search-->
                        <div class="hd_search">
                            <div class="search_icon">
                                <img src="https://cinestar.com.vn/assets/images/icon-search.svg">
                            </div>
                            <div class="search_panel" data-name="panel_search">
                                <div class="search_panel_form">
                                    <div>
                                        <div class="search_panel_form_content">
                                            <input class="search_content" type="text"
                                                placeholder="Tìm phim, thể loại,...">
                                            <button class="search_btn" type="submit">
                                                <img src="https://cinestar.com.vn/assets/images/ic-header-search.svg">
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!--Register/Login-->
                        <div class="hd_register_login">
                            <div class="hd_register_login_content">
                                <div class="hd_register_login_ava">
                                    <img src="https://cinestar.com.vn/assets/images/ic-header-auth.svg">
                                </div>
                                <div class="hd_register_login_list">
                                    {% if session.email %}
                                    <p>{{ session.email }} <a class="logout" href="{{ url_for('logout') }}">Đăng
                                            xuất</a>
                                    </p>
                                    {% else %}
                                    <a class="link" href="#">
                                        <i class="login"></i>Đăng nhập
                                    </a>
                                    <span class="separate">/</span>
                                    <a class="link" href="#">
                                        <i class="register"></i>Đăng kí
                                    </a>
                                    {% endif %}
                                </div>

                            </div>
                        </div>
                        <!--Language-->
                        <div class="hd_language">
                            <div class="hd_language_action">
                                <div class="hd_language_popup">
                                    <div class="hd_language_option">
                                        <span class="image">
                                            <img src="https://cinestar.com.vn/assets/images/footer-vietnam.svg">
                                        </span>
                                        <span class="text">
                                            VN
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="hd_chonrap_mid">
            <div class="container">
            </div>
            <div id="wrapper">
                <div id="main_content">
                    <div id="img_content">
                        <img src="{{ movie.url_poster }}" alt="{{ movie.ten_phim }}">
                    </div>
                    <div id="movie_content">
                        <div id="tenphim">
                            <h1>{{ movie.ten_phim }}</h1>
                        </div>
                        <p style="display: flex; line-height: 2;"><img src="../static/assets/icon-tag.svg" alt="">
                            {{
                            movie.the_loai }}</p>
                        <p style="display: flex;line-height: 2;"><img src="../static/assets/icon-clock.svg" alt="">
                            {{movie.thoi_luong }}'</p>
                        <h2 style="line-height: 2;">MÔ TẢ</h2>
                        <p style="line-height: 2;">Đạo diễn: {{ movie.dao_dien }}</p>
                        <p style="line-height: 2;">Diễn viên: {{ movie.dien_vien }}</p>
                        <p style="line-height: 2;">Khởi chiếu: {{ movie.ngay_khoi_chieu }}</p>
                        <h3 style="line-height: 2;">NỘI DUNG PHIM</h3>
                        <p style="line-height: 2;">{{ movie.noi_dung }}</p>
                        <p id="xem_trailer" style="display: flex; line-height: 2;text-decoration: underline;">
                            <a href="{{ movie.trailer }}" target="_blank">
                                <img src="../static/assets/icons8-play-64.png" alt="" width="30"> Xem Trailer
                            </a>
                        </p>
                    </div>
                </div>
            </div>
            <div class="select_seat">
                <h1>Chọn Suất Chiếu</h1>
                <div id="showtimes-container"></div>

                <h1>Chọn Ghế</h1>
                <div id="seats-container"></div>
            </div>
            <button id="confirm-seats">Xác nhận</button>

            <!-- modal -->
            <div id="confirmationModal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h2>Xác nhận thông tin</h2>
                    <p id="confirmationDetails"></p>
                    <button id="submit-confirmation">Xác nhận đặt vé</button>
                </div>
            </div>
            <script>
                let selectedShowtime = null;
                let selectedSeats = [];
                // Lấy URL hiện tại
                const currentUrl = window.location.href;
                // Tách chuỗi URL thành mảng các thành phần
                const urlParts = currentUrl.split('/');
                // Lấy ID phim từ thành phần cuối cùng của URL
                const movieId = urlParts[urlParts.length - 1];

                // Hàm gọi AJAX để lấy danh sách suất chiếu
                function loadShowtimes(movieId) {
                    fetch(`/api/get_showtimes/${movieId}`)
                        .then(response => response.json())
                        .then(data => {
                            const showtimesContainer = document.getElementById('showtimes-container');
                            showtimesContainer.innerHTML = ''; // Xóa nội dung cũ
                            // Lấy thời gian hiện tại
                            const now = new Date();
                            data.forEach(showtime => {
                                const showtimeDateTime = new Date(showtime.ngay_chieu + 'T' + showtime.gio_bat_dau);
                                // So sánh thời gian chiếu với thời gian hiện tại
                                if (showtimeDateTime > now) {
                                    const button = document.createElement('button');
                                    button.className = 'showtime-button';
                                    button.textContent = `Suất chiếu lúc: ${showtime.gio_bat_dau} - Ngày: ${showtime.ngay_chieu}`;
                                    button.onclick = () => selectShowtime(button, showtime.id_cachieu);
                                    showtimesContainer.appendChild(button);
                                }
                            });
                        })
                        .catch(error => console.error('Error:', error));
                }

                // Hàm gọi AJAX để lấy danh sách ghế
                function loadSeats(showtimeId) {
                    fetch(`/api/get_seats/${showtimeId}`)
                        .then(response => response.json())
                        .then(data => {
                            const seatsContainer = document.getElementById('seats-container');
                            seatsContainer.innerHTML = ''; // Xóa nội dung cũ
                            // Sắp xếp ghế theo cot và hang
                            data.sort((a, b) => {
                                if (a.cot < b.cot) return -1;
                                if (a.cot > b.cot) return 1;
                                return a.hang.localeCompare(b.hang);
                            });
                            // Tạo cột ghế
                            let currentColumn = null;
                            let columnDiv = null;
                            data.forEach(seat => {
                                if (seat.cot !== currentColumn) {
                                    currentColumn = seat.cot;
                                    columnDiv = document.createElement('div');
                                    columnDiv.className = 'seat-column';
                                    seatsContainer.appendChild(columnDiv);
                                }

                                const seatDiv = document.createElement('div');
                                seatDiv.className = 'seat ' + (seat.trang_thai ? 'booked' : 'available');
                                if (seat.hang === 'E') {
                                    seatDiv.classList.add('double-seat'); // Thêm lớp double-seat cho hàng ghế E
                                }
                                seatDiv.textContent = seat.hang + seat.cot;
                                if (!seat.trang_thai) { // Chỉ thêm sự kiện click cho ghế chưa đặt
                                    seatDiv.onclick = () => toggleSeatSelection(seatDiv, seat);
                                }
                                columnDiv.appendChild(seatDiv);
                            });
                        })
                        .catch(error => console.error('Error:', error));
                }
                function selectShowtime(button, showtimeId) {
                    selectedShowtime = showtimeId;
                    const buttons = document.querySelectorAll('.showtime-button');
                    buttons.forEach(btn => btn.style.backgroundColor = '#c0c0c0'); // Đặt lại màu nền của tất cả các nút
                    button.style.backgroundColor = '#008000'; // Đặt màu nền của nút được chọn
                    loadSeats(showtimeId);
                }


                function toggleSeatSelection(seatDiv, seat) {
                    if (seatDiv.classList.contains('selected')) {
                        seatDiv.classList.remove('selected');
                        selectedSeats = selectedSeats.filter(s => s.id !== seat.id);
                    } else {
                        seatDiv.classList.add('selected');
                        selectedSeats.push(seat);
                    }
                }
                // Gọi hàm loadShowtimes với ID của phim
                loadShowtimes(movieId);
                // Hiển thị modal xác nhận
                const confirmButton = document.getElementById('confirm-seats');
                confirmButton.onclick = () => {
                    if (selectedShowtime && selectedSeats.length > 0) {
                        const confirmationModal = document.getElementById('confirmationModal');
                        const confirmationDetails = document.getElementById('confirmationDetails');
                        confirmationDetails.innerHTML = `
                            <p>ID Suất chiếu: ${selectedShowtime}</p>
                            <p>Ghế đã chọn: ${selectedSeats.map(seat => seat.hang + seat.cot).join(', ')}</p>
                        `;
                        confirmationModal.style.display = 'block';
                    } else {
                        alert('Vui lòng chọn suất chiếu và ghế trước khi xác nhận.');
                    }
                };
                // Gửi dữ liệu lên server khi xác nhận đặt vé
                const submitButton = document.getElementById('submit-confirmation');
                var email = JSON.parse('{{ email | tojson | safe }}');
                submitButton.onclick = () => {
                    const tickets = selectedSeats.map(seat => ({
                        id_cachieu: selectedShowtime,
                        id_ghe: seat.id_ghe,
                        id_giave: seat.hang === 'E' ? 2 : 1, // Giả định ghế đôi ở hàng E có id_giave là 2
                        thanh_tien: seat.hang === 'E' ? 90000 : 45000, // Giả định ghế đôi ở hàng E có id_giave là 2
                        email: email
                    }));
                    fetch('/api/confirm_tickets', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(tickets),
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('Đặt vé thành công!');
                                location.reload(); // Tải lại trang sau khi đặt vé thành công
                            } else {
                                alert('Có lỗi xảy ra, vui lòng thử lại.');
                            }
                        })
                        .catch(error => console.error('Error:', error));
                };
                // Đóng modal khi nhấn vào dấu X
                const closeButton = document.querySelector('.close');
                closeButton.onclick = () => {
                    const confirmationModal = document.getElementById('confirmationModal');
                    confirmationModal.style.display = 'none';
                };
            </script>
            <div class="footer">
                <div>
                    <div class="container">
                        <div class="footer_components">
                            <div class="footer_list">
                                <!--Logo_Footer-->
                                <div class="footer_list-item col col4">
                                    <a class="main_logo_link_footer" href="#"> <!--Thay href-->
                                        <img src="../static/assets/logo4-2.png" width="800px" height="800px">
                                    </a>
                                </div>
                                <!--Column 1+2-->
                                <div class="footer_list-item sp">

                                    <div class="footer_list-item_top row">

                                        <div class="part">
                                            <div class="text">TÀI KHOẢN</div>
                                        </div>

                                        <div class="part">
                                            <div class="text">THUÊ SỰ KIỆN</div>
                                            <ul class="menu-list">
                                                <li class="menu-item">
                                                    <a class="menu-link" href="#">Thuê rạp</a> <!--Thay href-->
                                                </li>
                                            </ul>
                                        </div>

                                    </div>

                                    <div class="footer_list-item_bottom row">

                                        <div class="part">
                                            <div class="text">XEM PHIM</div>
                                            <ul class="menu-list">
                                                <li class="menu-item">
                                                    <a class="menu-link" href="#">Phim đang chiếu</a>
                                                    <!--Thay href-->
                                                </li>
                                                <li class="menu-item">
                                                    <a class="menu-link" href="#">Phim sắp chiếu</a>
                                                    <!--Thay href-->
                                                </li>
                                            </ul>
                                        </div>

                                        <div class="part">
                                            <div class="text">CINESTAR</div>
                                            <ul class="menu-list">
                                                <li class="menu-item">
                                                    <a class="menu-link" href="#">Giới thiệu</a> <!--Thay href-->
                                                </li>
                                                <li class="menu-item">
                                                    <a class="menu-link" href="#">Liên hệ</a> <!--Thay href-->
                                                </li>
                                            </ul>
                                        </div>

                                    </div>

                                </div>

                                <!--Column 3-->
                                <div class="footer_list-item aform">
                                    <div class="text">DỊCH VỤ KHÁC</div>
                                    <ul class="menu-list">
                                        <li class="menu-item">
                                            <a class="menu-link" href="#">Đặt đồ ăn</a> <!--Thay href-->
                                        </li>
                                        <li class="menu-item">
                                            <a class="menu-link" href="#">Coffee</a> <!--Thay href-->
                                        </li>
                                        <li class="menu-item">
                                            <a class="menu-link" href="#">Nhà hàng</a> <!--Thay href-->
                                        </li>
                                        <li class="menu-item">
                                            <a class="menu-link" href="#">Kidzone</a> <!--Thay href-->
                                        </li>
                                        <li class="menu-item">
                                            <a class="menu-link" href="#">Gym</a> <!--Thay href-->
                                        </li>
                                        <li class="menu-item">
                                            <a class="menu-link" href="#">Nhà hát Opera</a> <!--Thay href-->
                                        </li>
                                    </ul>
                                </div>

                                <!--Column 4-->
                                <div class="footer_list-item aform">
                                    <div class="text">HỆ THỐNG RẠP</div>
                                    <ul class="menu-list">
                                        <li class="menu-item">
                                            <a class="menu-link" href="#">Tất cả hệ thống rạp</a> <!--Thay href-->
                                        </li>
                                        <li class="menu-item">
                                            <a class="menu-link" href="#">CI9MA Nguyễn Trãi</a> <!--Thay href-->
                                        </li>
                                        <li class="menu-item">
                                            <a class="menu-link" href="#">CI9MA Hai Bà Trưng</a> <!--Thay href-->
                                        </li>
                                        <li class="menu-item">
                                            <a class="menu-link" href="#">CI9MA Bình Dương</a> <!--Thay href-->
                                        </li>
                                        <li class="menu-item">
                                            <a class="menu-link" href="#">CI9MA Kiên Giang</a> <!--Thay href-->
                                        </li>
                                        <li class="menu-item">
                                            <a class="menu-link" href="#">CI9MA Đà Lạt</a> <!--Thay href-->
                                        </li>
                                        <li class="menu-item">
                                            <a class="menu-link" href="#">CI9MA Huế</a> <!--Thay href-->
                                        </li>
                                    </ul>
                                </div>

                            </div>
                        </div>

                    </div>
                    <script src="../static/js/test.js"></script>
                    </footer>
</body>

</html>